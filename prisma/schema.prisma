// ================= GENERATOR & DATASOURCE =================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ================= RBAC SYSTEM =================

enum Role {
  ADMIN
  SUPPLIER
  INSTRUCTOR
  USER
}

enum Permission {
  VIEW_DASHBOARD
  MANAGE_ORDERS
  MANAGE_PRODUCTS
  MANAGE_COURSES
  MANAGE_USERS
  MANAGE_SEARCH
}

model UserRole {
  id          Int                @id @default(autoincrement())
  name        Role               @unique
  description String?
  users       User[]
  permissions UserRolePermission[]
}

model UserPermission {
  id          Int                @id @default(autoincrement())
  name        Permission         @unique
  description String?
  roles       UserRolePermission[]
  assignments UserPermissionAssignment[]
}

model UserRolePermission {
  roleId       Int
  permissionId Int
  role         UserRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   UserPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserPermissionAssignment {
  userId       Int
  permissionId Int
  conditions   Json? 
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   UserPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  assignedAt   DateTime       @default(now())

  @@id([userId, permissionId])
  @@index([permissionId])
}

// ================= SEARCH SYSTEM =================

enum EntityType {
  PRODUCT
  COURSE
}

model SearchIndex {
  id           Int         @id @default(autoincrement())
  entityType   EntityType
  entityId     Int
  title        String
  description  String?
  content      String?
  tags         String[]    @default([])
  category     String
  subcategory  String?
  level        String?
  price        Decimal     @db.Decimal(12, 2)
  rating       Decimal     @default(0) @db.Decimal(2, 1)
  popularity   Int         @default(0)
  isActive     Boolean     @default(true)
  language     String      @default("id")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([entityType, isActive])
  @@index([category, isActive])
  @@index([price, rating, popularity])
  @@index([language, isActive])
  @@unique([entityType, entityId])
}

model SearchQuery {
  id            Int      @id @default(autoincrement())
  userId        Int?
  query         String
  filters       Json?
  resultsCount  Int      @default(0)
  selectedItems Json?
  sessionId     String?
  ipAddress     String?
  searchedAt    DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([query, searchedAt])
  @@index([userId, searchedAt])
}

model SearchSuggestion {
  id          Int      @id @default(autoincrement())
  query       String   @unique
  popularity  Int      @default(1)
  category    String?
  language    String   @default("id")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([popularity, isActive])
  @@index([category, language, isActive])
}

// ================= USER MANAGEMENT =================

model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  firstName String?
  lastName  String?
  phone     String?
  address   String?
  avatar    String?
  roleId    Int?
  role      UserRole? @relation(fields: [roleId], references: [id], onDelete: SetNull)
  isBuyer   Boolean   @default(false)
  isStudent Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  assignmentSubmissions AssignmentSubmission[]
  carts                 Cart[]
  courseEnrollments     CourseEnrollment[]
  lessonProgresses      LessonProgress[]
  payments              Payment[]
  products              Product[]
  productOrders         ProductOrder[]
  productReviews        ProductReview[]
  courseReviews         CourseReview[]
  instructor            Instructor?
  refreshTokens         RefreshToken[]
  permissionAssignments UserPermissionAssignment[]
  searchQueries         SearchQuery[]

  @@index([email])
  @@index([roleId])
  @@index([deletedAt])
  @@index([firstName, lastName])
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device    String?
  ipAddress String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([token])
}

model Instructor {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  bio           String?
  profileImage  String?
  expertise     String[]
  experience    String?
  socialLinks   Json?
  isVerified    Boolean  @default(false)
  rating        Decimal  @default(0) @db.Decimal(2, 1)
  totalStudents Int      @default(0)
  totalCourses  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses Course[]

  @@index([isVerified, rating])
  @@index([totalStudents])
  @@index([deletedAt])
}

// ================= PRODUCT MANAGEMENT =================

enum ProductCategory {
  COFFEE
  TEA
  HERBAL
  EQUIPMENT
}

enum ProductOrigin {
  INDONESIA
  VIETNAM
  BRAZIL
  ETHIOPIA
  COLOMBIA
  GUATEMALA
  KENYA
  OTHER
}

enum ProductStatus {
  ACTIVE
  OUT_OF_STOCK
  DRAFT
  DISCONTINUED
}

enum ProductTag {
  ARABICA
  ROBUSTA
  GREEN_TEA
  BLACK_TEA
  WHITE_TEA
  HERBAL
  EQUIPMENT
  ORGANIC
  FAIR_TRADE
  SINGLE_ORIGIN
}

model Product {
  id          Int             @id @default(autoincrement())
  slug        String          @unique
  name        String
  description String?
  price       Decimal         @db.Decimal(12, 2)
  stock       Int             @default(0)
  images      String[]
  category    ProductCategory
  status      ProductStatus
  supplierId  Int
  rating      Decimal         @default(0) @db.Decimal(2, 1)
  reviewCount Int             @default(0)
  origin      ProductOrigin
  weight      String?
  tags        ProductTag[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?

  supplier   User               @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  orderItems ProductOrderItem[]
  reviews    ProductReview[]

  @@index([slug])
  @@index([name])
  @@index([description])
  @@index([category, status, deletedAt])
  @@index([rating, reviewCount])
  @@index([supplierId, status, deletedAt])
  @@index([deletedAt])
}

model ProductReview {
  id        Int      @id @default(autoincrement())
  productId Int
  userId    Int
  rating    Int      @db.SmallInt
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId, rating])
  @@index([userId, createdAt])
  @@unique([productId, userId])
}

// ================= COURSE MANAGEMENT =================

enum CourseCategory {
  COFFEE_BREWING
  COFFEE_ROASTING
  COFFEE_BUSINESS
  TEA_BREWING
  TEA_CEREMONY
  TEA_CULTURE
  HERBAL_PREPARATION
  HERBAL_MEDICINE
  HERBAL_GARDENING
  EQUIPMENT_USAGE
  BARISTA_SKILLS
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CourseStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

model Course {
  id               Int            @id @default(autoincrement())
  title            String
  slug             String         @unique
  description      String?
  shortDescription String?
  syllabus         String?
  price            Decimal        @db.Decimal(12, 2)
  instructorId     Int
  rating           Decimal        @default(0) @db.Decimal(2, 1)
  reviewCount      Int            @default(0)
  students         Int            @default(0)
  level            CourseLevel
  category         CourseCategory
  language         String         @default("id")
  subtitles        String[]       @default([])

  thumbnail        String?
  previewVideo     String?
  whatYouWillLearn String[]       @default([])
  requirements     String[]       @default([])
  targetAudience   String[]       @default([])
  totalDuration    Int?
  totalLessons     Int?
  certificate      Boolean        @default(false)

  status      CourseStatus @default(DRAFT)
  isPublished Boolean      @default(false)
  maxStudents Int?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  instructor  Instructor         @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  cartItems   CartItem[]
  enrollments CourseEnrollment[]
  modules     CourseModule[]
  reviews     CourseReview[]

  @@index([slug])
  @@index([title])
  @@index([shortDescription])
  @@index([category, level, status, deletedAt])
  @@index([rating, students])
  @@index([instructorId, isPublished, deletedAt])
  @@index([isPublished, createdAt])
  @@index([deletedAt])
}

model CourseReview {
  id        Int      @id @default(autoincrement())
  courseId  Int
  userId    Int
  rating    Int      @db.SmallInt
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId, rating])
  @@index([userId, createdAt])
  @@unique([courseId, userId])
}

model CourseModule {
  id          Int       @id @default(autoincrement())
  courseId    Int
  title       String
  description String?
  orderNumber Int
  isPublished Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId, orderNumber, deletedAt])
  @@index([courseId, isPublished, deletedAt])
}

enum LessonType {
  VIDEO
  ARTICLE
  QUIZ
  ASSIGNMENT
  LIVE_SESSION
}

model Lesson {
  id            Int        @id @default(autoincrement())
  moduleId      Int
  slug          String     @unique
  title         String
  description   String?
  duration      Int?
  type          LessonType @default(VIDEO)
  videoUrl      String?
  content       String?
  quizQuestions Json?
  passingScore  Decimal    @default(70) @db.Decimal(5, 2)
  orderNumber   Int
  isPreview     Boolean    @default(false)
  isPublished   Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deletedAt     DateTime?

  module      CourseModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  assignments Assignment[]
  progresses  LessonProgress[]

  @@index([slug])
  @@index([moduleId, orderNumber, deletedAt])
  @@index([moduleId, isPublished, deletedAt])
  @@index([isPreview])
}

model LessonProgress {
  lessonId    Int
  userId      Int
  completed   Boolean   @default(false)
  timeSpent   Int?      @default(0)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([lessonId, userId])
  @@index([userId, completed])
  @@index([lessonId, completed])
  @@index([userId, completed, createdAt])
}

model Assignment {
  id           Int       @id @default(autoincrement())
  lessonId     Int
  title        String
  instructions String
  dueDate      DateTime?
  maxScore     Decimal?  @db.Decimal(5, 2)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  lesson      Lesson                 @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]

  @@index([lessonId, deletedAt])
  @@index([dueDate])
}

model AssignmentSubmission {
  id           Int       @id @default(autoincrement())
  assignmentId Int
  userId       Int
  content      String?
  attachments  String[]  @default([])
  grade        Decimal?  @db.Decimal(5, 2)
  feedback     String?
  submittedAt  DateTime  @default(now())
  gradedAt     DateTime?

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([assignmentId, userId])
  @@index([userId, submittedAt])
  @@index([assignmentId, grade])
}

// ================= CART SYSTEM =================

enum CartItemType {
  PRODUCT
  COURSE
}

model Cart {
  id        Int       @id @default(autoincrement())
  userId    Int       @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items    CartItem[]
  payments Payment[]

  @@index([deletedAt])
}

model CartItem {
  id       Int          @id @default(autoincrement())
  cartId   Int
  itemType CartItemType

  productId Int?
  courseId  Int?

  quantity      Int       @default(1)
  priceSnapshot Decimal   @db.Decimal(12, 2)
  addedAt       DateTime  @default(now())
  deletedAt     DateTime?

  cart    Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([cartId, deletedAt])
  @@index([productId])
  @@index([courseId])
}

// ================= PAYMENT & ORDER SYSTEM =================

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

model Payment {
  id            Int           @id @default(autoincrement())
  userId        Int
  cartId        Int
  amount        Decimal       @db.Decimal(12, 2)
  paymentMethod String
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  cart              Cart               @relation(fields: [cartId], references: [id], onDelete: Cascade)
  courseEnrollments CourseEnrollment[]
  productOrders     ProductOrder[]

  @@index([userId, status, createdAt])
  @@index([status, paidAt])
  @@index([transactionId])
}

model ProductOrder {
  id         Int         @id @default(autoincrement())
  buyerId    Int
  paymentId  Int
  totalPrice Decimal     @db.Decimal(12, 2)
  status     OrderStatus @default(PENDING)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  buyer   User               @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  payment Payment            @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  items   ProductOrderItem[]

  @@index([buyerId, status])
  @@index([status, createdAt])
  @@index([paymentId])
}

model ProductOrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  priceEach Decimal @db.Decimal(12, 2)

  order   ProductOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
}

model CourseEnrollment {
  id                 Int       @id @default(autoincrement())
  courseId           Int
  studentId          Int
  paymentId          Int
  pricePaid          Decimal   @db.Decimal(12, 2)
  progress           Int       @default(0)
  certificateAwarded Boolean   @default(false)
  enrolledAt         DateTime  @default(now())
  completedAt        DateTime?
  lastAccessedAt     DateTime?

  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student     User         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payment     Payment      @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  certificate Certificate?

  @@unique([courseId, studentId])
  @@index([studentId, enrolledAt])
  @@index([courseId, progress])
  @@index([studentId, progress])
  @@index([certificateAwarded])
}

model Certificate {
  id                        Int       @id @default(autoincrement())
  enrollmentId              Int       @unique
  certificateNumber         String    @unique
  finalLessonsCompleted     Boolean   @default(false)
  finalAssignmentsCompleted Boolean   @default(false)
  eligible                  Boolean   @default(false)
  issuedAt                  DateTime?
  certificateUrl            String?

  enrollment CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([certificateNumber])
  @@index([eligible, issuedAt])
}